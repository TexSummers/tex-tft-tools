<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Should you Double Down?</title>
  <style>
    body {
      background: #121212;
      color:#e6edf3;
      font-family:'Segoe UI',sans-serif;
      text-align:center;
      padding:40px;
    }
    h1 { color:#58a6ff; margin-bottom:5px; }
    h2 { font-weight:normal; font-size:1rem; color:#8b949e; margin-bottom:30px; }

    p label { margin-right:10px; font-size:1rem; color:white; }
    input[type=number] {
      width:100px;
      font-size:1rem;
      padding:5px;
      margin-right:5px;
    }

    #calcBtn {
      padding:6px 12px;
      font-size:1rem;
      border:none;
      border-radius:6px;
      background:#238636;
      color:white;
      cursor:pointer;
      font-weight:bold;
      transition:0.2s;
    }
    #calcBtn:hover { background:#2ea043; }

    .round-buttons {
      display:flex;
      flex-wrap: wrap;
      justify-content:center;
      gap:10px;
      margin:10px 0 20px 0;
    }
    .round-buttons button {
      padding:10px 18px;
      border:none;
      border-radius:10px;
      background: linear-gradient(145deg, #1b2730, #2c3e50);
      color:white;
      font-weight:bold;
      cursor:pointer;
      transition:0.25s;
      box-shadow: 0 3px 6px rgba(0,0,0,0.3);
    }
    .round-buttons button:hover:not(:disabled) {
      background: linear-gradient(145deg, #2c3e50, #1b2730);
      box-shadow: 0 0 12px #58a6ff;
    }
    .round-buttons button.active {
      background:#58a6ff;
      box-shadow: 0 0 15px #58a6ff;
    }
    .round-buttons button:disabled {
      opacity:0.5;
      cursor:not-allowed;
      background:#6e7681;
    }

    .results-container {
      display:flex;
      justify-content:center;
      gap:20px;
      flex-wrap: wrap;
      margin-top:20px;
      min-height: 50px;
    }
    .dd-block {
      border:1px solid #30363d;
      border-radius:12px;
      padding:15px;
      min-width:220px;
      text-align:left;
      background:#161b22;
      box-shadow:0 4px 12px rgba(0,0,0,0.4);
      transition:0.2s;
    }

    .dd-block h3 {
      margin-top:0;
      margin-bottom:2px;
      font-size:1.1rem;
    }

    .current-stacks { 
      font-size:0.85rem; 
      color:#8b949e; 
      margin-bottom:4px; 
      margin-top:2px; 
    }
    .next-cashout {
      font-size:0.85rem; 
      color:#8b949e; 
      margin-top:1px;   /* tighter spacing */
      margin-bottom:4px; 
    }
    .gain-base { color:#3fb950; font-weight:bold; }
    .gain-kills { color:#f0c93d; font-weight:bold; }
    .error-note { color:#f85149; font-size:1rem; text-align:center; }
    .note { font-size:0.85rem; color:#8b949e; font-style:italic; margin-top:5px; }
    p.total { margin-top:2px; font-weight:normal; } /* tighter spacing */
    p.total b { color:#58a6ff; }
    .label-white { color:white; } /* removed bold */
  </style>
</head>
<body>
  <h1>Should you Double Down?</h1>
  <h2>A tool to help your Crystal Gambit cashout!</h2>

  <p>
    <label>Current stacks: 
      <input type="number" id="currentStacks" min="0" value="">
    </label>

    <label>Avg. kills per round: 
      <input type="number" id="avgKills" min="0" value="0">
    </label>

    <button id="calcBtn">Calculate</button>
  </p>

  <p class="label-white" style="margin-top:10px;">
    Doubling Down on:
  </p>
  <div class="round-buttons" id="roundButtons"></div>

  <div id="output" class="results-container"></div>

  <script>
    const values = {
      2: { loss: 26, kill: 4 },
      3: { loss: 32, kill: 5 },
      4: { loss: 48, kill: 7 },
      5: { loss: 48, kill: 7 },
      6: { loss: 48, kill: 7 },
      7: { loss: 48, kill: 7 }
    };

    const breakpoints = [30,65,100,135,170,210,250,300,350,400,500,600,700,800,900,1000,1100,1200];

    const roundsByStage = {
      2: ["2-1","2-2","2-3","2-5","2-6","2-7"],
      3: ["3-1","3-2","3-3","3-5","3-6","3-7"],
      4: ["4-1","4-2","4-3","4-5","4-6","4-7"]
    };

    const selectableRounds = ["2-5","2-6","2-7","3-2","3-3","3-5","3-6","3-7","4-2","4-3","4-5","4-6","4-7"];
    const allRounds = [].concat(...Object.values(roundsByStage));
    const roundButtonsDiv = document.getElementById("roundButtons");
    const output = document.getElementById("output");

    allRounds.forEach(r => {
      const btn = document.createElement("button");
      btn.textContent = r;
      if(!selectableRounds.includes(r)) btn.disabled = true;
      btn.addEventListener("click", () => {
        if(btn.disabled) return;
        document.querySelectorAll(".round-buttons button").forEach(b => b.classList.remove("active"));
        btn.classList.add("active"); // immediately apply active color
        calculate(r);
      });
      roundButtonsDiv.appendChild(btn);
    });

    function nextRound(stage, round) {
      const rounds = roundsByStage[stage];
      let idx = rounds.indexOf(round);
      if (idx === -1) return [stage, rounds[0]];
      idx++;
      if (idx >= rounds.length) {
        stage++;
        if (!roundsByStage[stage]) {
          roundsByStage[stage] = [`${stage}-1`, `${stage}-2`, `${stage}-3`, `${stage}-5`, `${stage}-6`, `${stage}-7`];
        }
        return [stage, roundsByStage[stage][0]];
      }
      return [stage, rounds[idx]];
    }

    function getBreakpoint(stacks) {
      let bp = 0;
      for (let i=0;i<breakpoints.length;i++){
        if(stacks >= breakpoints[i]) bp = breakpoints[i];
      }
      return bp;
    }

    function getNextCashout(stacks){
      for(let i=0;i<breakpoints.length;i++){
        if(stacks < breakpoints[i]) return breakpoints[i];
      }
      return "Max";
    }

    function simulateDoubleDown(startStage, startRound, startingStacks, avgKills) {
      let stacks = startingStacks;
      let breakdown = [];
      let turns = 0;
      let currentStage = startStage;
      let currentRound = startRound;

      while (turns < 3) {
        if (!currentRound.endsWith("-7")) {
          const base = values[currentStage].loss;
          const kills = avgKills * values[currentStage].kill;
          const gain = base + kills;
          stacks += gain;
          breakdown.push(`${currentRound} â†’ ${stacks} (<span class="gain-base">+${base}</span>${kills>0 ? `+<span class="gain-kills">${kills}</span>` : ""})`);
          turns++;
        }
        [currentStage, currentRound] = nextRound(currentStage, currentRound);
      }

      return { stacks, breakdown, nextRound: currentRound, nextStage: currentStage };
    }

    function calculate(selectedRound) {
      let stacksInput = document.getElementById("currentStacks").value;
      if(stacksInput === "" || parseInt(stacksInput) === 0){
        output.style.display = 'flex';
        output.innerHTML = `<div class="error-note">Enter some stacks first, FOOL</div>`;
        return;
      }

      const activeBtn = document.querySelector(".round-buttons button.active");
      if(!activeBtn){
        output.innerHTML = `<div class="error-note">Choose a stage first, FOOL</div>`;
        return;
      }

      let stacks = parseInt(stacksInput);
      let avgKills = parseInt(document.getElementById("avgKills").value) || 0;
      let stage = parseInt(selectedRound.split("-")[0]);

      output.style.display = 'flex';
      output.innerHTML = '';

      const firstDD = simulateDoubleDown(stage, selectedRound, stacks, avgKills);
      const secondDD = simulateDoubleDown(firstDD.nextStage, firstDD.nextRound, firstDD.stacks, avgKills);
      const thirdDD = simulateDoubleDown(secondDD.nextStage, secondDD.nextRound, secondDD.stacks, avgKills);

      const firstBP = getBreakpoint(firstDD.stacks);
      const secondBP = getBreakpoint(secondDD.stacks);
      const thirdBP = getBreakpoint(thirdDD.stacks);

      const createBlock = (title, currentStacks, ddObj, bp, noteText='') => {
        const nextBP = getNextCashout(ddObj.stacks);
        const stacksToNext = nextBP === "Max" ? "N/A" : nextBP - ddObj.stacks;
        const block = document.createElement('div');
        block.classList.add('dd-block');
        block.innerHTML = `
          <h3>${title}</h3>
          <div class="current-stacks">(current stacks: ${currentStacks})</div>
          <ul>${ddObj.breakdown.map(r => `<li>${r}</li>`).join('')}</ul>
          <p class="total">Total: <b>${ddObj.stacks} stacks</b></p>
          <div class="next-cashout">(${stacksToNext} stacks away from ${nextBP} cashout)</div>
          <p>Expected Cashout: <b>${bp}</b> <b>on</b> <b>${ddObj.nextRound}</b></p>
          ${noteText}
        `;
        return block;
      };

      output.appendChild(createBlock("Double Down", stacks, firstDD, firstBP));
      output.appendChild(createBlock("Second Double Down", firstDD.stacks, secondDD, secondBP));
      let note3 = stage === 4 ? `<div class="note">(but you're probably dead...)</div>` : '';
      output.appendChild(createBlock("Third Double Down", secondDD.stacks, thirdDD, thirdBP, note3));

      if(stage === 2) {
        const fourthDD = simulateDoubleDown(thirdDD.nextStage, thirdDD.nextRound, thirdDD.stacks, avgKills);
        const fourthBP = getBreakpoint(fourthDD.stacks);
        output.appendChild(createBlock("Fourth Double Down", thirdDD.stacks, fourthDD, fourthBP));
      }
    }

    document.getElementById("calcBtn").addEventListener("click", () => {
      const activeBtn = document.querySelector(".round-buttons button.active");
      const stacksVal = document.getElementById("currentStacks").value;
      if(stacksVal === "" || parseInt(stacksVal) === 0){
        output.innerHTML = `<div class="error-note">Enter some stacks first, FOOL</div>`;
      } else if(!activeBtn){
        output.innerHTML = `<div class="error-note">Choose a stage first, FOOL</div>`;
      } else {
        calculate(activeBtn.textContent);
      }
    });
  </script>
</body>
</html>
